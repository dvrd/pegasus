name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Pin to a known-good Odin commit (matches our local dev build).
  # Monthly release binaries lag behind and have breaking os package changes.
  ODIN_COMMIT: 109d68d0229266627c014e2ad2b8eb1ae45d4b7b

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Odin build
        id: cache-odin
        uses: actions/cache@v4
        with:
          path: ~/odin
          key: odin-build-${{ env.ODIN_COMMIT }}

      - name: Install LLVM
        if: steps.cache-odin.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq llvm-18 clang-18

      - name: Build Odin from source
        if: steps.cache-odin.outputs.cache-hit != 'true'
        run: |
          curl -fsSL "https://github.com/odin-lang/Odin/archive/${ODIN_COMMIT}.tar.gz" -o odin-src.tar.gz
          mkdir -p ~/odin
          tar xzf odin-src.tar.gz -C ~/odin --strip-components=1
          rm odin-src.tar.gz
          cd ~/odin
          LLVM_CONFIG=llvm-config-18 make release
        timeout-minutes: 10

      - name: Add Odin to PATH
        run: echo "$HOME/odin" >> $GITHUB_PATH

      - name: Verify Odin
        run: odin version

      - name: Run unit tests (188 tests)
        run: odin test lib -collection:pegasus=./lib -all-packages

      - name: Build optimized binary
        run: |
          mkdir -p bin
          odin build lib -collection:pegasus=./lib -o:speed -out:bin/pegasus

      - name: JS regression tests (76 files)
        run: |
          count=0
          fail=0
          for f in test/fixtures/js/*.js; do
            size=$(wc -c < "$f" | tr -d ' ')
            if [ "$size" -lt 100 ]; then continue; fi
            count=$((count+1))
            base=$(basename "$f")
            timeout 120 ./bin/pegasus grammars/javascript.peg --file "$f" --quiet 2>/dev/null
            if [ $? -ne 0 ]; then
              fail=$((fail+1))
              echo "::error::FAIL: $base ($size bytes)"
            fi
          done
          echo ""
          echo "=== JS Regression Results ==="
          echo "Tested: $count files"
          echo "Failed: $fail files"
          if [ "$fail" -gt 0 ]; then
            exit 1
          fi
